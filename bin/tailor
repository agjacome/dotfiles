#!/bin/bash -eu

declare -r log_file=$1
declare -r sb="stdbuf -i0 -oL"

shift
tput sc
$@ 2>&1 \
    | $sb tee $log_file \
    | $sb cut -c-$(tput cols) \
    | $sb sed -u 's/\(.\)/\\\1/g' \
    | $sb xargs -0 -d '\n' -iyosi -n1 bash -c 'tput rc; tput el; printf "\r%s" yosi'

declare -r exit_code=${PIPESTATUS[0]}
tput rc; tput el; printf "\r"

exit $exit_code
