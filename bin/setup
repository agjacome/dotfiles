#!/usr/bin/env bash
set -euo pipefail

function require_curl() {
    if ! command -v curl &> /dev/null; then
        echo "Please install curl first"
        exit 1
    fi
}

function install_nix() {
    if ! command -v nix &> /dev/null; then
        echo "Installing Nix..."
        sh <(curl -L https://nixos.org/nix/install) --daemon
    fi
}

function setup_home_manager() {
    local -r expr='with import <nixpkgs> {}; fetchgit { url = "https://github.com/agjacome/dotfiles.git"; }'
    local -r run='home-manager switch --flake github:agjacome/dotfiles'

    nix-shell -E "${expr}" --run "${run}"
}

function setup_chezmoi() {
    chezmoi init agjacome --apply --exclude externals
    chezmoi apply --include externals
}

function import_gpg_keys() {
    gpg --import $HOME/.gnupg/private_keys.pgp
}

function main() {
    require_curl
    install_nix
    setup_home_manager
    setup_chezmoi
    import_gpg_keys
}

main
