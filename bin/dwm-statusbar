#!/bin/bash
set -euo pipefail
shopt -s extglob
IFS=$'\n\t'

function mpd_song() {
    echo $(mpc current -f '%artist% – %title%')
}

function spotify_song() {
    local -r prem=$(xprop -name "Spotify Premium - Linux Preview" _NET_WM_ICON_NAME 2> /dev/null | cut -d'"' -f2 | cut -b 11-)
    local -r free=$(xprop -name "Spotify Free - Linux Preview" _NET_WM_ICON_NAME    2> /dev/null | cut -d'"' -f2 | cut -b 11-)

    [[ -z $prem ]] && echo $free || echo $prem
}

function current_playing_song() {
    local song=$(mpd_song)
    local song=${song:-$(spotify_song)}

    local song=$([[ -z $song ]] && echo "off" || echo $song | awk -F' – ' '{ print $2 " \\uE01B " $1 }' | head -c 100)
    echo -ne "\x04\uE01A\x0B \uE00E $song"
}

function current_unread_emails() {
    local -i unread=0
    for maildir in $(find $HOME/var/mail/*/Inbox/new -type d); do
        local -i unread=$((unread + $(ls -1 $maildir | wc -l)))
    done

    echo -ne "\x05\uE01A\x0C \uE014 $unread"
}

function current_volume_level() {
    local -r vol=$(amixer get Master | tail -1 | sed -r 's/.*\[([0-9%]{2,4})\].*/\1/')
    echo -ne "\x04\uE01A\x06 \uE015 $vol"
}

function current_cpu_usage() {
    local -r usage=$(mpstat | grep 'all' | awk -F' ' '{ gsub(",", ".", $12); print 100 - $12 }')
    echo -ne "\x04\uE01A\x09 \uE00F ${usage}%"
}

function current_memory_usage() {
    local -r mem=$(free -m | awk '/Mem/ { print $3 }')
    echo -ne "\uE01B \uE010 ${mem}MiB"
}

function current_downloaded_bytes() {
    echo $(paste -d'+' /sys/class/net/!(lo)/statistics/rx_bytes | bc)
}

function current_uploaded_bytes() {
    echo $(paste -d'+' /sys/class/net/!(lo)/statistics/tx_bytes | bc)
}

function current_download_rate() {
    local -r rate=$(echo "($1 - $2) / $3" | bc)
    echo -ne "\x05\uE01A\x08 \uE011 ${rate}K"
}

function current_upload_rate() {
    local -r rate=$(echo "($1 - $2) / $3" | bc)
    echo -ne "\x01\uE01B\x07 \uE012 ${rate}K"
}

function current_date_hour() {
    local -r datetime=$(date "+%a %d %b \\uE01B %H:%M")
    echo -ne "\x05\uE01A\x02 \uE016 $datetime"
}

declare -r wait_seconds=${1:-5}
declare -r wait_network=$((1024 * $wait_seconds))

declare -i down_bytes_old=$(current_downloaded_bytes)
declare -i upld_bytes_old=$(current_uploaded_bytes)
while true; do
    declare -i down_bytes_now=$(current_downloaded_bytes)
    declare -i upld_bytes_now=$(current_uploaded_bytes)

    declare song=$(current_playing_song)
    declare email=$(current_unread_emails)
    declare cpu=$(current_cpu_usage)
    declare memory=$(current_memory_usage)
    declare downloaded=$(current_download_rate $down_bytes_now $down_bytes_old $wait_network)
    declare uploaded=$(current_upload_rate $upld_bytes_now $upld_bytes_old $wait_network)
    declare volume=$(current_volume_level)
    declare date=$(current_date_hour)

    xsetroot -name "$song $email $cpu $memory $downloaded $uploaded $volume $date"

    declare -i down_bytes_old=$down_bytes_now
    declare -i upld_bytes_old=$upld_bytes_now
    sleep $wait_seconds
done
