#!/usr/bin/env bash
set -euo pipefail

declare -r http_remote="https://github.com/agjacome/dotfiles.git"
declare -r ssh_remote="git@github.com:agjacome/dotfiles.git"
declare -r local="$HOME/.dotfiles"

function main() {
    echo "Setting up nix..."
    setup_nix
    echo

    echo "Cloning dotfiles repo..."
    clone_repository
    echo

    echo "Setting up home-manager..."
    setup_home_manager
    echo

    echo "Setting up chezmoi..."
    setup_chezmoi
    echo

    echo "Setting up fish..."
    setup_fish
    echo

    echo "Importing GPG keys..."
    import_gpg_keys
    echo

    echo "Setup complete!"
}

function setup_nix() {
    if command -v nix &> /dev/null; then
        return
    fi

    if command -v pacman &> /dev/null; then
        sudo pacman -Syu --noconfirm nix
        return
    fi

    sh <(curl -L https://nixos.org/nix/install)
    mkdir -p $HOME/.local/state/nix/profiles
}

function clone_repository() {
    if [[ -d ${local} ]]; then
        return
    fi

    nix-shell ${local}/shell.nix -p git --run "\
        git clone ${http_remote} ${local} && \
        cd ${local} && \
        git remote set-url origin ${ssh_remote}"
}

function setup_home_manager() {
    nix-shell --run "home-manager switch --impure --flake ${local}"
}

function setup_chezmoi() {
    chezmoi init  -S ${local}
    chezmoi apply -S ${local} --exclude externals
    chezmoi apply -S ${local} --include externals
}

function setup_fish() {
    if ! chsh -l | grep -q $(which fish); then
        echo $(which fish) | sudo tee -a /etc/shells
    fi

    chsh -s $(which fish)

    fish -c "fisher update"
}

function import_gpg_keys() {
    gpg --batch --import $HOME/.gnupg/private_keys.pgp
}

